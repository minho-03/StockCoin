<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>StockCoin - ì£¼ì‹ ì‹œì„¸</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/price.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


</head>

<body class="d-flex flex-column min-vh-100">
<nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="/">ğŸ“ˆ StockCoin</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="/">í™ˆ</a></li>
                <li class="nav-item"><a class="nav-link active" href="/priceStock">ì‹œì„¸ë³´ê¸°</a></li>
                <li class="nav-item"><a class="nav-link" href="/favorites">ê´€ì‹¬ì¢…ëª©</a></li>
                <li class="nav-item"><a class="nav-link" href="/chat">ì±„íŒ…</a></li>
                <li class="nav-item"><a class="nav-link" href="/join">íšŒì›ê°€ì…</a></li>
                <li class="nav-item"><a class="nav-link" href="/login">ë¡œê·¸ì¸</a></li>
            </ul>
        </div>
    </div>
</nav>

<main class="flex-fill container my-5">
    <ul class="nav nav-tabs mb-4">
        <li class="nav-item"><a class="nav-link active" href="/priceStock">ì£¼ì‹ ì‹œì„¸</a></li>
        <li class="nav-item"><a class="nav-link" href="/priceCoin">ì½”ì¸ ì‹œì„¸</a></li>
    </ul>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="input-group w-50">
            <input type="text" id="searchInput" class="form-control" placeholder="ì¢…ëª©ëª… ë˜ëŠ” ì½”ë“œ ê²€ìƒ‰">
            <button class="btn btn-dark" id="searchBtn">ê²€ìƒ‰</button>
        </div>
        <div class="text-end">
            <button class="btn btn-outline-dark" id="refreshBtn">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            <div id="updateTime" class="mt-1 small text-secondary">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: -</div>
        </div>
    </div>

    <div id="loadingSpinner" class="loading-spinner">
        <div class="spinner-border text-dark" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <table class="table table-hover text-center align-middle" style="display:none;" id="stockTable">
        <thead class="table-dark">
        <tr>
            <th>â­</th>
            <th>ì¢…ëª©ëª…</th>
            <th class="sortable" data-sort="price">í˜„ì¬ê°€</th>
            <th class="sortable" data-sort="rate">ë“±ë½ë¥ </th>
            <th class="sortable" data-sort="volume">ê±°ë˜ëŸ‰</th>
        </tr>
        </thead>
        <tbody id="stockTableBody"></tbody>
    </table>
</main>

<!-- âœ… ì°¨íŠ¸ ëª¨ë‹¬ -->
<div class="modal fade" id="chartModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-dark text-light">
                <h5 class="modal-title" id="modalTitle">ì¢…ëª© ì°¨íŠ¸</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="chartContainer"></div>
            </div>
        </div>
    </div>
</div>

<footer class="bg-dark text-light text-center py-3 mt-auto">
    <p class="mb-0">Â© 2025 StockCoin Project</p>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let allStocks = [];
    let originalStocks = [];
    let chartInstance = null;
    let sortState = { column: null, order: "none" };

    // âœ… í‘œ ë Œë”ë§
    function renderTable(data) {
      const tableBody = document.getElementById("stockTableBody");
      tableBody.innerHTML = data.map(stock => {
        const rateValue = parseFloat(stock.changeRate.replace(/[^0-9.-]/g, ""));
        const isUp = rateValue > 0;
        const isDown = rateValue < 0;
        const rateColor = isUp ? "text-danger fw-bold" : isDown ? "text-primary fw-bold" : "text-secondary";
        const rateIcon = isUp ? "â–² " : isDown ? "â–¼ " : "";

        return `
          <tr data-code="${stock.code}" data-name="${stock.name}">
            <td>â­</td>
            <td class="text-start ps-3">${stock.name}</td>
            <td class="text-end pe-3">${stock.price}</td>
            <td class="text-end pe-3 ${rateColor}">${rateIcon}${stock.changeRate}</td>
            <td class="text-end pe-3">${stock.volume}</td>
          </tr>
        `;
      }).join("");

      document.querySelectorAll("#stockTableBody tr").forEach(row => {
        row.addEventListener("click", () => showChartModal(row.dataset.name, row.dataset.code));
      });
    }

    // âœ… ì°¨íŠ¸ ëª¨ë‹¬ (ê¸°ê°„ ë²„íŠ¼ í¬í•¨)
    async function showChartModal(name, code) {
      const modalEl = document.getElementById("chartModal");
      const modal = new bootstrap.Modal(modalEl);
      document.getElementById("modalTitle").textContent = `${name} (${code}) ì°¨íŠ¸`;

      const chartContainer = document.getElementById("chartContainer");
      chartContainer.innerHTML = `
        <div class="d-flex justify-content-center mb-3 gap-2">
          <button class="btn btn-sm btn-outline-dark period-btn active" data-period="1m">1ê°œì›”</button>
          <button class="btn btn-sm btn-outline-dark period-btn" data-period="3m">3ê°œì›”</button>
          <button class="btn btn-sm btn-outline-dark period-btn" data-period="6m">6ê°œì›”</button>
        </div>
        <canvas id="stockChart" style="height:400px;"></canvas>
      `;

      const ctx = document.getElementById("stockChart").getContext("2d");

      async function loadChart(period = "1m") {
        try {
          const res = await axios.get(`/api/korea/detail/${code}?period=${period}`);
          const data = res.data;

          if (chartInstance) chartInstance.destroy();

          chartInstance = new Chart(ctx, {
            data: {
              labels: data.labels,
              datasets: [
                {
                  type: "line",
                  label: `${name} ì£¼ê°€`,
                  data: data.prices,
                  borderColor: "#007bff",
                  backgroundColor: "rgba(0,123,255,0.15)",
                  borderWidth: 2,
                  tension: 0.3,
                  yAxisID: "yPrice"
                },
                {
                  type: "bar",
                  label: "ê±°ë˜ëŸ‰",
                  data: data.volumes,
                  backgroundColor: "rgba(180,180,180,0.5)",
                  yAxisID: "yVolume"
                }
              ]
            },
            options: {
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                title: { display: true, text: `${name} (${period}) ì£¼ê°€ & ê±°ë˜ëŸ‰` }
              },
              scales: {
                yPrice: { position: "left" },
                yVolume: { position: "right", grid: { drawOnChartArea: false } }
              }
            }
          });
        } catch (err) {
          chartContainer.innerHTML = `<p class="text-danger text-center">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>`;
        }
      }

      chartContainer.addEventListener("click", e => {
        if (e.target.classList.contains("period-btn")) {
          document.querySelectorAll(".period-btn").forEach(btn => btn.classList.remove("active"));
          e.target.classList.add("active");
          loadChart(e.target.dataset.period);
        }
      });

      await loadChart("1m");
      modal.show();
    }

    // âœ… í—¤ë” í´ë¦­ ì •ë ¬ (3ë‹¨ê³„)
    document.addEventListener("click", (e) => {
      if (!e.target.classList.contains("sortable")) return;

      const column = e.target.dataset.sort;
      let order = "asc";
      if (sortState.column === column) {
        if (sortState.order === "asc") order = "desc";
        else if (sortState.order === "desc") order = "none";
      }
      sortState = { column, order };

      let sorted = [];
      if (order === "none") sorted = [...originalStocks];
      else {
        sorted = [...allStocks];
        const key = { price: "price", rate: "changeRate", volume: "volume" }[column];
        sorted.sort((a, b) => {
          const valA = parseFloat(a[key].replace(/[^0-9.-]/g, ""));
          const valB = parseFloat(b[key].replace(/[^0-9.-]/g, ""));
          return order === "asc" ? valA - valB : valB - valA;
        });
      }

      renderTable(sorted);
      document.querySelectorAll("th.sortable").forEach(th => th.classList.remove("sorted", "asc", "desc"));
      if (order !== "none") e.target.classList.add("sorted", order);
    });

    async function loadStockData() {
      const spinner = document.getElementById("loadingSpinner");
      const table = document.getElementById("stockTable");
      const updateTime = document.getElementById("updateTime");

      spinner.style.display = "flex";
      table.style.display = "none";

      try {
        const res = await axios.get("/api/korea/list");
        allStocks = res.data;
        originalStocks = [...allStocks];
        renderTable(allStocks);
        spinner.style.display = "none";
        table.style.display = "table";
        updateTime.textContent = "ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: " + new Date().toLocaleTimeString("ko-KR");
      } catch {
        spinner.innerHTML = `<p class="text-danger">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</p>`;
      }
    }

    document.getElementById("searchBtn").addEventListener("click", () => {
      const keyword = document.getElementById("searchInput").value.trim();
      if (!keyword) return renderTable(allStocks);
      const filtered = allStocks.filter(s => s.name.includes(keyword) || s.code.includes(keyword));
      renderTable(filtered);
    });

    document.getElementById("refreshBtn").addEventListener("click", loadStockData);
    document.addEventListener("DOMContentLoaded", loadStockData);
</script>
</body>
</html>
