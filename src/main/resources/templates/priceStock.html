<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>StockCoin - ì£¼ì‹ ì‹œì„¸</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/price.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

</head>
<body class="d-flex flex-column min-vh-100">

<!-- âœ… Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="/">ğŸ“ˆ StockCoin</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="/">í™ˆ</a></li>
                <li class="nav-item"><a class="nav-link active" href="/priceStock">ì‹œì„¸ë³´ê¸°</a></li>
                <li class="nav-item"><a class="nav-link" href="/favorites">ê´€ì‹¬ì¢…ëª©</a></li>
                <li class="nav-item"><a class="nav-link" href="/chat">ì±„íŒ…</a></li>
                <li class="nav-item"><a class="nav-link" href="/join">íšŒì›ê°€ì…</a></li>
                <li class="nav-item"><a class="nav-link" href="/login">ë¡œê·¸ì¸</a></li>
            </ul>
        </div>
    </div>
</nav>

<!-- âœ… Main -->
<main class="flex-fill container my-5">

    <!-- ìƒë‹¨ íƒ­ -->
    <ul class="nav nav-tabs mb-4">
        <li class="nav-item">
            <a class="nav-link active" href="/priceStock">ì£¼ì‹ ì‹œì„¸</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="/priceCoin">ì½”ì¸ ì‹œì„¸</a>
        </li>
    </ul>

    <!-- ê²€ìƒ‰ ë° ë²„íŠ¼ + ê°±ì‹ ì‹œê° -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="input-group w-50">
            <input type="text" id="searchInput" class="form-control" placeholder="ì¢…ëª©ëª… ë˜ëŠ” ì½”ë“œ ê²€ìƒ‰">
            <button class="btn btn-dark" id="searchBtn">ê²€ìƒ‰</button>
        </div>

        <div class="d-flex flex-column align-items-end">
            <div class="btn-group mb-1">
                <button class="btn btn-outline-dark" id="sortPriceBtn">ê°€ê²©ìˆœ</button>
                <button class="btn btn-outline-dark" id="sortRateBtn">ë“±ë½ë¥ ìˆœ</button>
                <button class="btn btn-outline-dark" id="refreshBtn">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            </div>
            <div class="update-time" id="updateTime">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: -</div>
        </div>
    </div>

    <!-- âœ… ë¡œë”© ìŠ¤í”¼ë„ˆ -->
    <div id="loadingSpinner" class="loading-spinner">
        <div class="spinner-border text-dark" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- âœ… ì‹œì„¸ í‘œ -->
    <table class="table table-hover text-center align-middle" style="display:none;" id="stockTable">
        <thead class="table-dark">
        <tr>
            <th>â­</th>
            <th>ì¢…ëª©ëª…</th>
            <th>í˜„ì¬ê°€</th>
            <th>ë“±ë½ë¥ </th>
            <th>ê±°ë˜ëŸ‰</th>
        </tr>
        </thead>
        <tbody id="stockTableBody"></tbody>
    </table>

</main>

<!-- âœ… Footer -->
<footer class="bg-dark text-light text-center py-3 mt-auto">
    <p class="mb-0">Â© 2025 StockCoin Project</p>
</footer>

<script>
    let allStocks = [];
    let sortPriceAsc = true;
    let sortRateAsc = true;

    // âœ… í…Œì´ë¸” ë Œë”ë§ í•¨ìˆ˜
    function renderTable(data) {
      const tableBody = document.getElementById("stockTableBody");
      tableBody.innerHTML = data.map(stock => {
        const rateValue = parseFloat(stock.changeRate.replace(/[^0-9.-]/g, ""));
        const isUp = stock.changeRate.includes("+") || rateValue > 0;
        const isDown = stock.changeRate.includes("-") || rateValue < 0;

        let rateColor = "text-secondary";
        let rateIcon = "";
        if (isUp) {
          rateColor = "text-danger fw-bold";
          rateIcon = "â–² ";
        } else if (isDown) {
          rateColor = "text-primary fw-bold";
          rateIcon = "â–¼ ";
        }

        return `
          <tr>
            <td>â­</td>
            <td class="text-start ps-3">${stock.name}</td>
            <td class="text-end pe-3">${stock.price}</td>
            <td class="text-end pe-3 ${rateColor}">${rateIcon}${stock.changeRate}</td>
            <td class="text-end pe-3">${stock.volume}</td>
          </tr>
        `;
      }).join("");

      const rows = tableBody.querySelectorAll("tr");
      rows.forEach((row, i) => setTimeout(() => row.classList.add("show"), i * 20));
    }

    // âœ… í˜„ì¬ ì‹œê° í¬ë§·
    function getCurrentTime() {
      const now = new Date();
      const hh = String(now.getHours()).padStart(2, '0');
      const mm = String(now.getMinutes()).padStart(2, '0');
      const ss = String(now.getSeconds()).padStart(2, '0');
      return `${hh}:${mm}:${ss}`;
    }

    // âœ… ë°ì´í„° ë¡œë”©
    async function loadStockData() {
      const spinner = document.getElementById("loadingSpinner");
      const table = document.getElementById("stockTable");
      const updateTime = document.getElementById("updateTime");

      spinner.style.display = "flex";
      table.style.display = "none";
      spinner.style.opacity = "1";

      try {
        const res = await axios.get("/api/korea/list");
        allStocks = res.data;
        renderTable(allStocks);

        spinner.style.opacity = "0";
        setTimeout(() => {
          spinner.style.display = "none";
          table.style.display = "table";
        }, 300);

        updateTime.textContent = "ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: " + getCurrentTime();
      } catch (err) {
        console.error(err);
        spinner.innerHTML = `<p class="text-danger">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</p>`;
      }
    }

    // âœ… ì •ë ¬ ê¸°ëŠ¥
    document.getElementById("sortPriceBtn").addEventListener("click", () => {
      const btn = document.getElementById("sortPriceBtn");
      const sorted = [...allStocks].sort((a, b) => {
        const priceA = Number(a.price.replace(/,/g, ""));
        const priceB = Number(b.price.replace(/,/g, ""));
        return sortPriceAsc ? priceA - priceB : priceB - priceA;
      });
      renderTable(sorted);
      btn.textContent = sortPriceAsc ? "ê°€ê²©ìˆœ â–¼" : "ê°€ê²©ìˆœ â–²";
      sortPriceAsc = !sortPriceAsc;
    });

    document.getElementById("sortRateBtn").addEventListener("click", () => {
      const btn = document.getElementById("sortRateBtn");
      const sorted = [...allStocks].sort((a, b) => {
        const rateA = parseFloat(a.changeRate.replace(/[^0-9.-]/g, ""));
        const rateB = parseFloat(b.changeRate.replace(/[^0-9.-]/g, ""));
        return sortRateAsc ? rateA - rateB : rateB - rateA;
      });
      renderTable(sorted);
      btn.textContent = sortRateAsc ? "ë“±ë½ë¥ ìˆœ â–¼" : "ë“±ë½ë¥ ìˆœ â–²";
      sortRateAsc = !sortRateAsc;
    });

    // âœ… ê²€ìƒ‰
    document.getElementById("searchBtn").addEventListener("click", () => {
      const keyword = document.getElementById("searchInput").value.trim();
      if (!keyword) {
        renderTable(allStocks);
        return;
      }
      const filtered = allStocks.filter(stock =>
        stock.name.includes(keyword) || stock.code.includes(keyword)
      );
      renderTable(filtered);
    });

    // âœ… ìƒˆë¡œê³ ì¹¨
    document.getElementById("refreshBtn").addEventListener("click", loadStockData);

    // âœ… ì²« ë¡œë“œì‹œ ì‹¤í–‰
    document.addEventListener("DOMContentLoaded", loadStockData);
</script>
</body>
</html>
